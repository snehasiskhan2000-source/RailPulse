<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>RailPulse Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="text-slate-100">

    <div id="screen-home" class="p-4 max-w-md mx-auto min-h-screen">
        <header class="py-6 flex justify-between items-center">
            <h1 class="text-2xl font-black italic text-blue-500">RAIL<span class="text-white">PULSE</span></h1>
        </header>

        <div class="glass-card p-6 mb-4">
            <div class="space-y-4 relative">
                <input id="fromInput" oninput="getSuggestions(this, 'from')" placeholder="From Station" class="w-full bg-slate-900/50 p-4 rounded-xl border border-slate-700 outline-none focus:border-blue-500">
                <div id="from-sug" class="hidden absolute left-0 right-0 rounded-xl overflow-hidden shadow-2xl z-50"></div>
                
                <input id="toInput" oninput="getSuggestions(this, 'to')" placeholder="To Station" class="w-full bg-slate-900/50 p-4 rounded-xl border border-slate-700 outline-none focus:border-blue-500">
                <div id="to-sug" class="hidden absolute left-0 right-0 rounded-xl overflow-hidden shadow-2xl z-50"></div>
                
                <button onclick="findTrains()" class="w-full bg-green-600 py-4 rounded-xl font-bold text-lg hover:bg-green-500 transition-all">Find Trains</button>
            </div>
        </div>

        <div class="glass-card p-4">
            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-4">Search by Train</p>
            <div class="flex gap-2">
                <input id="directTrain" placeholder="Train No / Name" class="flex-1 bg-slate-900/50 p-3 rounded-lg border border-slate-700 outline-none">
                <button onclick="trackDirect()" class="bg-blue-600 px-6 rounded-lg font-bold">Track</button>
            </div>
        </div>
    </div>

    <div id="screen-list" class="hidden p-4 max-w-md mx-auto min-h-screen">
        <button onclick="showHome()" class="mb-4 text-sm text-blue-400">‚Üê Back to Search</button>
        <div id="train-results" class="space-y-3"></div>
    </div>

    <div id="screen-track" class="hidden max-w-md mx-auto min-h-screen">
        <div class="sticky top-0 z-50 bg-slate-900 p-4 border-b border-slate-800 flex items-center justify-between">
            <button onclick="showList()" class="text-xl">‚úï</button>
            <h2 id="tracker-title" class="text-xs font-bold truncate px-4">Loading Pulse...</h2>
            <div class="text-[10px] bg-slate-800 px-2 py-1 rounded">Today</div>
        </div>
        <div class="relative pt-6 px-4">
            <div class="track-line"></div>
            <div id="active-track" class="track-active" style="height: 0%"></div>
            <div id="tracker-content"></div>
        </div>
    </div>

    <script>
        // State Management
        let selectedFrom = "";
        let selectedTo = "";

        function showHome() { document.querySelectorAll('[id^="screen-"]').forEach(s => s.classList.add('hidden')); document.getElementById('screen-home').classList.remove('hidden'); }
        function showList() { document.querySelectorAll('[id^="screen-"]').forEach(s => s.classList.add('hidden')); document.getElementById('screen-list').classList.remove('hidden'); }
        function showTrack() { document.querySelectorAll('[id^="screen-"]').forEach(s => s.classList.add('hidden')); document.getElementById('screen-track').classList.remove('hidden'); }

        // Autocomplete Logic
        async function getSuggestions(input, type) {
            if(input.value.length < 2) return;
            const res = await fetch(`/api/search-station?q=${input.value}`);
            const data = await res.json();
            const box = document.getElementById(`${type}-sug`);
            box.innerHTML = "";
            box.classList.remove('hidden');
            
            data.body.forEach(s => {
                const div = document.createElement('div');
                div.className = "bg-slate-800 p-4 border-b border-slate-700 cursor-pointer hover:bg-slate-700";
                div.innerHTML = `<span class="bg-blue-600/20 text-blue-400 px-2 py-1 rounded text-[10px] font-bold mr-3">${s.stationCode}</span> ${s.stationName}`;
                div.onclick = () => {
                    input.value = s.stationName;
                    if(type === 'from') selectedFrom = s.stationCode;
                    else selectedTo = s.stationCode;
                    box.classList.add('hidden');
                };
                box.appendChild(div);
            });
        }

        // Find Trains Logic
        async function findTrains() {
            showList();
            const results = document.getElementById('train-results');
            results.innerHTML = "<p class='text-center py-10 animate-pulse'>Fetching Trains...</p>";
            
            const res = await fetch(`/api/find-trains?from=${selectedFrom}&to=${selectedTo}`);
            const data = await res.json();
            results.innerHTML = "";
            
            data.body.trains.forEach(t => {
                results.innerHTML += `
                    <div onclick="trackDirect('${t.trainNumber}')" class="glass-card p-4 cursor-pointer hover:ring-1 ring-blue-500 transition-all">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-sm"><span class="bg-blue-600 px-2 py-0.5 rounded mr-2">${t.trainNumber}</span> ${t.trainName}</h3>
                            <span class="text-[10px] text-slate-500">${t.duration}</span>
                        </div>
                        <div class="flex justify-between text-xs font-bold">
                            <span>${t.departureTime} ‚Üí ${t.arrivalTime}</span>
                            <span class="text-blue-400">View Route</span>
                        </div>
                    </div>`;
            });
        }

        // Live Tracking UI
        async function trackDirect(num) {
            const trainNo = num || document.getElementById('directTrain').value;
            showTrack();
            const content = document.getElementById('tracker-content');
            content.innerHTML = "<div class='text-center py-20'>Establishing Satellite Link...</div>";
            
            const date = new Date().toISOString().slice(0,10).replace(/-/g,"");
            const res = await fetch(`/api/status?trainNo=${trainNo}&date=${date}`);
            const data = await res.json();
            
            if(data.body) renderTracker(data.body);
        }

        function renderTracker(body) {
            document.getElementById('tracker-title').innerText = body.train_status_message;
            const content = document.getElementById('tracker-content');
            content.innerHTML = "";
            
            let reachedCurrent = false;
            body.stations.forEach((s, i) => {
                const isCurrent = s.stationCode === body.current_station;
                if(isCurrent) reachedCurrent = true;

                content.innerHTML += `
                    <div class="relative flex items-center pl-16 py-6 group">
                        <div class="absolute left-[24px] w-3 h-3 rounded-full z-20 ${reachedCurrent ? 'bg-blue-500' : 'bg-slate-700'}"></div>
                        
                        ${isCurrent ? `
                            <div class="train-pulsar">üöÜ</div>
                            <div class="absolute left-[70px] top-4 bg-green-700 text-[10px] px-2 py-1 rounded font-bold">
                                ${body.train_status_message}
                            </div>
                        ` : ''}

                        <div class="flex-1">
                            <h4 class="text-xs font-bold ${reachedCurrent ? 'text-white' : 'text-slate-500'}">${s.stationName}</h4>
                            <p class="text-[9px] text-slate-500">${s.distance} km ‚Ä¢ Platform ${s.platformNumber || '--'}</p>
                        </div>
                        <div class="text-right text-[11px] font-bold">
                            <div class="${reachedCurrent ? 'text-green-500' : 'text-slate-600'}">${s.arrivalTime !== "0" ? s.arrivalTime : '--'}</div>
                            <div class="text-slate-500 text-[9px]">Dept: ${s.departureTime !== "0" ? s.departureTime : 'End'}</div>
                        </div>
                    </div>`;
            });

            // Progress bar update
            const idx = body.stations.findIndex(s => s.stationCode === body.current_station);
            const progress = ((idx + 1) / body.stations.length) * 100;
            document.getElementById('active-track').style.height = `${progress}%`;
        }
    </script>
</body>
</html>
